---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# twfeivdecomp

<!-- badges: start -->
<!-- badges: end -->

## Overview

`twfeivdecomp` is a package for decomposing the two-way fixed effects instrumental variable (TWFEIV) estimator under staggered instrumented difference-in-differences (DID-IV) designs.  
The package decomposes the TWFEIV estimator into a weighted average of all possible Wald-DID estimators, providing a transparent view of how different 2x2 comparisons contribute to the overall estimate.  

The decomposition can be performed both with and without time-varying controls.

## Installation
You can install the development version of twfeivdecomp from GitHub:

``` r
library(devtools)
install_github("shomiyaji/twfeiv-decomp")
```

## Functions
-`twfeiv_decomp()`: decomposes the TWFEIV estimator into all possible Wald-DID estimators, with or without time-varying controls.  

## Data

The package includes an example dataset `simulation_data`, which is a small simulated panel dataset.  
It contains 72 observations (12 units observed over 6 time periods) with the following variables:

- `id`: Unit identifier  
- `time`: Time period (2000â€“2005)  
- `instrument`: Binary instrument variable  
- `treatment`: Treatment variable  
- `outcome`: Outcome variable  
- `control1`, `control2`: Additional control variables  

## Example

This is a basic example which shows how to decompose the TWFEIV estimator into its Wald-DID components using the `twfeivdecomp` package.
```{r example}
library(twfeivdecomp)
decomposition_result <- twfeiv_decomp(outcome ~ treatment | instrument,
                                      data = simulation_data,
                                      id_var = "id",
                                      time_var = "time",
                                      summary_output = F)

# Decomposition result
head(decomposition_result)

# Print the summary
print_summary(data = decomposition_result, return_df = FALSE)

# Print the figure
library(ggplot2)

ggplot(decomposition_result) +
  aes(x = weight, y = Wald_DID_estimate, 
      shape = factor(design_type), 
      color = factor(design_type)) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(x = "Weight", y = "Wald DID estimate", 
       shape = "Design type", color = "Design type") +
  theme(
    legend.position = "bottom",     
    legend.box = "horizontal"       
  )


```

## References
- Miyaji, Sho. (2024). *Instrumented Difference-in-Differences with Heterogeneous Treatment Effects.*  
  arXiv:2405.12083. Available at: <https://arxiv.org/abs/2405.12083>

- Miyaji, Sho. (2024). *Two-Way Fixed Effects Instrumental Variable Regressions in Staggered DID-IV Designs.*  
  arXiv:2405.16467. Available at: <https://arxiv.org/abs/2405.16467>